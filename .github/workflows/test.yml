name: Django CI

on: [pull_request, push]
env:
    DOCKER_USER: ${{secrets.DOCKER_USER}}
    DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
    REGISTRY: docker.io
    DEBUG: ${{ secrets.DEBUG }}
    SECRET_KEY: ${{ secrets.SECRET_KEY }}
    DJANGO_ALLOWED_HOSTS: ${{ vars.ACTION_DJANGO_ALLOWED_HOSTS }}
    CELERY_BROKER: ${{ vars.CELERY_BROKER }}
    CELERY_BACKEND: ${{ vars.CELERY_BACKEND }}

jobs:
    test_project:
        runs-on: ubuntu-latest # operating system your code will run on
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-python@v2
            - name: Run script file
              run: |
                  chmod +x ./apps/setup_env.sh
                  bash ./apps/setup_env.sh
                  cp ./apps/codeln3d/settings/base.ci.py ./apps/codeln3d/settings/base.py
            - run: cat ./apps/.env
            - run: pip install flake8
            - run: pip install setuptools
            - run: pip install -r apps/requirements.txt # install all our dependencies for the project
            - run: flake8 . # run flake8 test
            - run: |
                  cd apps/
                  python manage.py test

    push-image-to-docker-hub:  # job name
        runs-on: ubuntu-latest  # runner name : (ubuntu latest version) 
        steps:
        - uses: actions/checkout@v2 # first action : checkout source code
        - name: Create env file
          run: |
              chmod +x ./apps/setup_env.sh
              bash ./apps/setup_env.sh
        - name: docker login
          run: | # log into docker hub account
              docker login -u $DOCKER_USER -p $DOCKER_PASSWORD $REGISTRY
        - name: Pull Web and nginx image # push The image to the docker hub
          run: |
              docker pull ${{secrets.DOCKER_USER}}/codeln3d_celery || true
              docker pull ${{secrets.DOCKER_USER}}/codeln3d_celery-beat || true
              docker pull ${{secrets.DOCKER_USER}}/codeln3d_dashboard || true
              docker pull ${{secrets.DOCKER_USER}}/codeln3d_web || true
        - name: Build Web and nginx image
          run: docker-compose -f docker-compose.ci.yml build
        - name: Push to Docker Hub
          run: |
              docker pull ${{secrets.DOCKER_USER}}/codeln3d_celery
              docker pull ${{secrets.DOCKER_USER}}/codeln3d_celery-beat
              docker pull ${{secrets.DOCKER_USER}}/codeln3d_dashboard
              docker pull ${{secrets.DOCKER_USER}}/codeln3d_web