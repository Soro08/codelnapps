name: quality-and-test

on: 
    pull_request:
      branches: 
        - master
    push:
env:
    # Default
    DEBUG: ${{ secrets.DEBUG }}
    SECRET_KEY: ${{ secrets.SECRET_KEY }}
    DJANGO_ALLOWED_HOSTS: ${{ secrets.ACTION_DJANGO_ALLOWED_HOSTS }}
    CELERY_BROKER: ${{ secrets.CELERY_BROKER }}
    CELERY_BACKEND: ${{ secrets.CELERY_BACKEND }}
    # AWS S3
    AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
    AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
    AWS_STORAGE_BUCKET_NAME: ${{secrets.AWS_STORAGE_BUCKET_NAME}}
    # Docker images
    DOCKER_USER: ${{secrets.DOCKER_USER}}
    DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
    REGISTRY: docker.io
    WEB_IMAGE: ${{ secrets.WEB_IMAGE }}
    CELERY_IMAGE: ${{ secrets.CELERY_IMAGE }}
    BEAT_IMAGE: ${{ secrets.BEAT_IMAGE }}
    DASH_IMAGE: ${{ secrets.DASH_IMAGE }}
    NGINX_IMAGE: ${{ secrets.NGINX_IMAGE }}
    # Nginx proxy
    VIRTUAL_HOST: ${{secrets.VIRTUAL_HOST}}
    VIRTUAL_PORT: ${{secrets.VIRTUAL_PORT}}
    # let encrypted
    DEFAULT_EMAIL: ${{secrets.DEFAULT_EMAIL}}

jobs:
    test_project:
        runs-on: ubuntu-latest # operating system your code will run on
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-python@v2
            - name: Run script file
              run: |
                  chmod +x ./apps/setup_env.sh
                  bash ./apps/setup_env.sh
                  cp ./apps/codeln3d/settings/base.ci.py ./apps/codeln3d/settings/base.py
            - run: cat ./apps/.env
            - run: pip install flake8
            - run: pip install setuptools
            - run: pip install -r apps/requirements.txt # install all our dependencies for the project
            - run: flake8 . # run flake8 test
            - run: |
                  cd apps/
                  python manage.py test